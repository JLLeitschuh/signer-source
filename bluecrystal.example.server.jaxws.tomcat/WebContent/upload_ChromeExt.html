<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" >

<!--
    Blue Crystal: Document Digital Signature
    Copyright (C) 2007-2015  Sergio Leal

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

<html>
<head>
<title>Extensão do Chrome - Assinatura com Politica de Assinatura
	(ICP-Brasil)</title>
<script type="text/javascript"
	src="http://code.jquery.com/jquery-1.10.1.min.js"></script>


<script>
            window.onload = function() {
                var dropbox = document.getElementById("dropbox");
                dropbox.addEventListener("dragenter", noop, false);
                dropbox.addEventListener("dragexit", noop, false);
                dropbox.addEventListener("dragover", noop, false);
                dropbox.addEventListener("drop", dropUpload, false);
            }

            function noop(event) {
                event.stopPropagation();
                event.preventDefault();
            }

            function dropUpload(event) {
                noop(event);
                var files = event.dataTransfer.files;

                for (var i = 0; i < files.length; i++) {
                    upload(files[i]);
                }
            }

            function upload(file) {
                document.getElementById("status").innerHTML = "Uploading " + file.name;

                var formData = new FormData();
                formData.append("file", file);

                var xhr = new XMLHttpRequest();
                xhr.upload.addEventListener("progress", uploadProgress, false);
                xhr.addEventListener("load", uploadComplete, false);
                xhr.open("POST", "uploadServlet", true); // If async=false, then you'll miss progress bar support.
                xhr.send(formData);
            }

            function uploadProgress(event) {
                // Note: doesn't work with async=false.
                var progress = Math.round(event.loaded / event.total * 100);
                document.getElementById("status").innerHTML = "Progress " + progress + "%";
            }

            function uploadComplete(event) {
                document.getElementById("status").innerHTML = event.target.responseText;
                assinar();
            }
        </script>
<style>
#dropbox {
	width: 300px;
	height: 200px;
	border: 1px solid gray;
	border-radius: 5px;
	padding: 5px;
	color: gray;
}
</style>



</head>
<body>



<script type="text/javascript">

$(document).ready(function() {

	try
	{
		isActive();
	}
	catch(Err)
	{

		alert('Erro (catch): ' + Err);
	}


});

function isActive(){
	return true;
	
}

function bluc_certb64_onchange(){
	
	var appCertb64Span = document.querySelector("#bluc_certb64");
	var certB64enc = appCertb64Span.innerHTML; 
	parseCert(certB64enc);
	

}

function bluc_signed_attr_onchange(){
	
		
}

function bluc_signed_envelope_onchange(){
	
	var status = document.querySelector("#bluc_status");
	alert(status.innerHTML);
}


function bluc_error_code_onchange(){
	var message = document.querySelector("#bluc_error_message");
	alert(message.innerHTML);
}


function createEnvelope(certificate, payload, hashAlg, time_value, hash_value, sign)
{
	<!-- STEP 5: CREATE ENV -->
	$.ajax({
		 type: 'GET',
	        url: 'CreateEnvelope',
	        data: {
	        	hash_value: hash_value,
	        	time_value: time_value,
	        	sa_value: payload,
	        	signed_value: sign,
	        	cert: certificate,
	        	alg: hashAlg
	        },
	        success: function (data) {
	        	var json = $.parseJSON(data);
	        	var signedContent = json.signedContent;
	        	var isOk = json.isOk;
	        	var certB64 =  json.certB64;
	        	var certSubject =  json.certSubject;
	        	if(isOk){
	        		 $("#signedEnvelope").text(signedContent);
	        	 } else {
	        		 alert('Assinatura inválida');
	        	 }
	        },
            error: function (error) {
                alert('error: ' + eval(error));
            }

		});

	
}

function signContent(certificate, thumbprint, payload, hashAlg, time_value, hash_value)
{
   alert('signContent');
	
}



var alg = 'sha1';
var cert_thumb = '';
var cert_content = '';

function loadCert(){

	
	
}




function parseCert(certificate){
	$.ajax({
        type: 'GET',
        url: 'ParseCert',
        data: {cert:  certificate},
        success: function (data) {
        	var json = $.parseJSON(data);
        	var html = '<table><tr><th>Nome</th><th>Valor</th></tr>';
        	 
        	for(var i = 0; i < json.length; i++){
	        	html += '<tr><td>'+json[i].name+'</td><td>'+json[i].value+'</td></tr>';
        	 }
        	 html += '</table>';
        	 $("#parsedCert").html(html);
        	
        },
        error: function (error) {
            alert('error: ' + eval(error));
        }
	});
}

function assinar()
{
	try
		{
		loadCert();
		 
    	<!-- 1 do Cert -->

		}
		catch(Err)
		{

			alert('Erro (catch): ' + Err);
		}
}
</script>
	Extensão do Chrome - Assinatura com Politica de Assinatura(ICP-Brasil)
	<br>Powered by
	<b>BluC</b>
	<br>

	<h1>Para testar com outra tecnologia escolha um dos links abaixo.</h1>
	<a href="upload_activexNoSP.html">ActiveX - Assinatura sem Politica
		de Assinatura</a>
	<br />
	<a href="upload_java_capi.html">Applet Java (MS-CAPI) - Assinatura
		com Politica de Assinatura(ICP-Brasil)</a>
	<br />
	<a href="upload_java_capiNoSP.html">Applet Java (MS-CAPI) -
		Assinatura sem Politica de Assinatura</a>
	<br />
	<a href="upload_java_p11.html">Applet Java (PKCS#11) - Assinatura
		com Politica de Assinatura(ICP-Brasil)</a>
	<br />
	<a href="upload_java_p11NoSP.html">Applet Java (PKCS#11) -
		Assinatura sem Politica de Assinatura</a>
	<br />
	<a href="upload_RestSigner.html">Rest Signer - Assinatura com Politica de Assinatura</a><br/>
	
	
	<br/>
	<a href="https://chrome.google.com/webstore/detail/blue-crystal-signer/inlgdajmhicinhamnepnpdneamfgjcgl?hl=pt-BR&authuser=2"><h1>Antes de iniciar o processo instale a entensão do Chrome</h1></a><br/>
	<h1><a href="https://github.com/bluecrystalsign/signer-source-vstudio/tree/master/dist">E o 'native messaging' daqui</a><br/></h1>
	
	
	<h1>Passo 1: Arraste um documento para a area abaixo.</h1>
	<div id="dropbox">Arraste o arquivo que deseja assinar para
		aqui...</div>
	<div id="status"></div>

	<h1>
		
		Passo 3: na janela exibida
		selecione o certificado que deseja utilizar e aguarde.</br> Serão exibidos
		os dados do certificado e em seguida das assinatura.
	</h1>
	<p>
	<h1>Certificado</h1>
	<br />
	<span id="parsedCert">...</span>
	<p>
	<p>
	<h1>Assinatura</h1>
	<br />
	<span id="bluc_signed_envelope">...</span>
	<p>
	<div style="display: none;">
	    <b>response:</b> <div id='response'></div>
	    <b>error code:</b> <span id="bluc_error_code" onchange="bluc_error_code_onchange();"></span><br/>
    	<b>error message:</b> <span id="bluc_error_message" ></span><br/>
    	<b>load icon:</b> <span id="bluc_load_icon" >true</span><br/>
		<b>status:</b> <span id="bluc_status" ></span><br/>
		<b>message:</b> <span id="message"></span><br/>
		<b>certb64:</b> <span id="bluc_certb64" onchange="bluc_certb64_onchange();"></span><br/>
		<b>thumbprint:</b> <span id="bluc_thumbprint"></span><br/>
		<b>subject:</b> <span id="bluc_subject"></span><br/>
		<b>keySize:</b> <span id="bluc_key_size"></span><br/>
		<b>hash:</b> <span id="bluc_hash"></span><br/>
		<b>hash alg:</b> <span id="bluc_hash_alg"></span><br/>
		<b>time:</b> <span id="bluc_time"></span><br/>
		<b>sa:</b> <span id="bluc_signed_attr" onchange="bluc_signed_attr_onchange();"></span><br/>
		
		<b>loadSignatureUrl:</b> <span id="bluc_load_signature_url">http://localhost:8080/example/LoadSignature</span><br/>
		<b>CreateEnvelopeUrl:</b> <span id="bluc_create_envelope_url">http://localhost:8080/example/CreateEnvelope</span><br/>
	</div>
</body>
</html>

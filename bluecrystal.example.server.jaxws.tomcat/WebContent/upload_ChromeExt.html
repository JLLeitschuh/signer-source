<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" >

<!--
    Blue Crystal: Document Digital Signature
    Copyright (C) 2007-2015  Sergio Leal

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU Affero General Public License as
    published by the Free Software Foundation, either version 3 of the
    License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU Affero General Public License for more details.

    You should have received a copy of the GNU Affero General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->

<html>
<head>
<title>Extensao do Chrome - Assinatura com Politica de
	Assinatura (ICP-Brasil)</title>

<script type="text/javascript"
	src="http://code.jquery.com/jquery-1.10.1.min.js"></script>


<!-- Bootstrap -->
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
	integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7"
	crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"
	integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r"
	crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
	integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
	crossorigin="anonymous"></script>

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css"
	integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7"
	crossorigin="anonymous">

<!-- Optional theme -->
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap-theme.min.css"
	integrity="sha384-fLW2N01lMqjakBkx3l/M9EahuwpSfeNvV63J5ezn3uZzapT0u7EYsXMjQV+0En5r"
	crossorigin="anonymous">

<!-- Latest compiled and minified JavaScript -->
<script
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"
	integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS"
	crossorigin="anonymous"></script>


<script>
	window.onload = function() {
		var dropbox = document.getElementById("dropbox");
		dropbox.addEventListener("dragenter", noop, false);
		dropbox.addEventListener("dragexit", noop, false);
		dropbox.addEventListener("dragover", noop, false);
		dropbox.addEventListener("drop", dropUpload, false);
	}

	function noop(event) {
		event.stopPropagation();
		event.preventDefault();
	}

	function dropUpload(event) {
		noop(event);
		var files = event.dataTransfer.files;

		for (var i = 0; i < files.length; i++) {
			upload(files[i]);
		}
	}

	function upload(file) {
		document.getElementById("status").innerHTML = "Uploading " + file.name;

		var formData = new FormData();
		formData.append("file", file);

		var xhr = new XMLHttpRequest();
		xhr.upload.addEventListener("progress", uploadProgress, false);
		xhr.addEventListener("load", uploadComplete, false);
		xhr.open("POST", "uploadServlet", true); // If async=false, then you'll miss progress bar support.
		xhr.send(formData);
	}

	function uploadProgress(event) {
		// Note: doesn't work with async=false.
		var progress = Math.round(event.loaded / event.total * 100);
		document.getElementById("status").innerHTML = "Progress " + progress
				+ "%";
	}

	function uploadComplete(event) {
		//document.getElementById("status").innerHTML = event.target.responseText;        	 	

		showSucess(event.target.responseText);
	}
</script>
<style>
#dropbox {
	width: 300px;
	height: 200px;
	border: 1px solid gray;
	border-radius: 5px;
	padding: 5px;
	color: gray;
}
</style>



</head>
<body>

	<script type="text/javascript">
		$(document).ready(function() {

			try {
				isActive();
				$("#alert_box_sucess").hide();
				$("#alert_box_warning").hide();
				$("#alert_box_error").hide();
				$("#msg_install_ext_chrome").show();
				$("#extension_alert").show();
				$("#native_alert").show();

			} catch (Err) {

				alert('Erro (catch): ' + Err);
			}

		});

		function isActive() {
			return true;

		}

		function showSucess(msg) {
			$("#alert_conten_sucess").text(msg);
			$("#alert_box_sucess").show();
			$("#alert_box_warning").hide();
			$("#alert_box_error").hide();

		}

		function showWarning(msg) {
			$("#alert_conten_warning").text(msg);
			$("#alert_box_sucess").hide();
			$("#alert_box_warning").show();
			$("#alert_box_error").hide();

		}

		function showError(msg) {
			$("#alert_conten_error").text(msg);
			$("#alert_box_sucess").hide();
			$("#alert_box_warning").hide();
			$("#alert_box_error").show();

		}

		function bluc_certb64_onchange() {

			var appCertb64Span = document.querySelector("#bluc_certb64");
			var certB64enc = appCertb64Span.innerHTML;

			parseCert(certB64enc);

		}

		function bluc_signed_envelope_onchange() {
			showSucess('assinatura exibida.');
		}

		function bluc_signed_attr_onchange() {

		}

		function bluc_status_onchange() {
			
			showWarning( $("bluc_status").text() );

		}

		function bluc_error_code_onchange() {
			var message = document.querySelector("#bluc_error_message");
			alert(message.innerHTML);

		}

		function bluc_load_extension_onchange() {
			$("#msg_install_ext_chrome").hide();
			$("#extension_alert").hide();
		}

		function bluc_load_native_onchange() {
			$("#msg_install_native").hide();
			$("#native_alert").hide();
		}

		
		
		function createEnvelope(certificate, payload, hashAlg, time_value,
				hash_value, sign) {

			$.ajax({
				type : 'GET',
				url : 'CreateEnvelope',
				data : {
					hash_value : hash_value,
					time_value : time_value,
					sa_value : payload,
					signed_value : sign,
					cert : certificate,
					alg : hashAlg
				},
				success : function(data) {
					var json = $.parseJSON(data);
					var signedContent = json.signedContent;
					var signStatus = json.signStatus;
					var statusMessage = json.statusMessage;
					var certB64 = json.certB64;
					var certSubject = json.certSubject;
					if (signStatus == 0) {
						$("#signedEnvelope").text(signedContent);
					}
					alert("Status da Assinatura: " + statusMessage);
				},
				error : function(error) {
					alert('error: ' + eval(error));
				}

			});

		}

		function signContent(certificate, thumbprint, payload, hashAlg,
				time_value, hash_value) {
			alert('signContent');

		}

		var alg = 'sha1';
		var cert_thumb = '';
		var cert_content = '';

		function loadCert() {

		}

		function parseCert(certificate) {
			$.ajax({
				type : 'GET',
				url : 'ParseCert',
				data : {
					cert : certificate
				},
				success : function(data) {
					var json = $.parseJSON(data);
					var html = '<table><tr><th>Nome</th><th>Valor</th></tr>';

					for (var i = 0; i < json.length; i++) {
						html += '<tr><td>' + json[i].name + '</td><td>'
								+ json[i].value + '</td></tr>';
					}
					html += '</table>';
					$("#parsedCert").html(html);
					showSucess('certificado carregado');

				},
				error : function(error) {
					alert('error: ' + eval(error));
				}
			});
		}

		function assinar() {
			try {
				loadCert();

			} catch (Err) {

				alert('Erro (catch): ' + Err);
			}
		}
	</script>

	<div class="alert alert-warning" id="extension_alert"  style="display:none">
		<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
		<strong>Aviso</strong> <span id="alert_conten_warning">
		Parece que seu navegador ainda não tem a extensão Blue Crystal instalada. <a href="https://chrome.google.com/webstore/detail/blue-crystal-signer/inlgdajmhicinhamnepnpdneamfgjcgl?hl=pt-BR&authuser=2">
		Antes de iniciar o processo instale a entensao.</a>
		</span>
	</div>

	<div class="alert alert-warning" id="native_alert"  style="display:none">
		<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
		<strong>Aviso</strong> <span id="alert_conten_warning">
		Parece que seu computador ainda não tem o componente nativo Blue Crystal instalada. <a id="msg_install_ext_native" href="https://github.com/bluecrystalsign/signer-source-vstudio/tree/master/dist">Instale o 'native messaging' daqui</a>
		</span>
	</div>



	<div class="alert alert-success" id="alert_box_sucess">
		<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
		<strong>Successo!</strong> <span id="alert_conten_sucess"></span>
	</div>

	<div class="alert alert-warning" id="alert_box_warning">
		<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
		<strong>Aviso</strong> <span id="alert_conten_warning"></span>
	</div>

	<div class="alert alert-danger" id="alert_box_error">
		<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>
		<strong>Erro</strong> <span id="alert_conten_error"></span>
	</div>

	Extensao do Chrome - Assinatura com Politica de Assinatura(ICP-Brasil)
	<br>Powered by
	<a target== "_blank" href="http://www.bluecryst.al">Blue Crystal </a>
	<br>

	<h4>Para testar com outra tecnologia escolha um dos links abaixo.</h4>
	<a href="upload_activexNoSP.html">ActiveX - Assinatura sem Politica
		de Assinatura</a>
	<br />
	<a href="upload_java_capi.html">Applet Java (MS-CAPI) - Assinatura
		com Politica de Assinatura(ICP-Brasil)</a>
	<br />
	<a href="upload_java_capiNoSP.html">Applet Java (MS-CAPI) -
		Assinatura sem Politica de Assinatura</a>
	<br />
	<a href="upload_java_p11.html">Applet Java (PKCS#11) - Assinatura
		com Politica de Assinatura(ICP-Brasil)</a>
	<br />
	<a href="upload_java_p11NoSP.html">Applet Java (PKCS#11) -
		Assinatura sem Politica de Assinatura</a>
	<br />
	<a href="upload_RestSigner.html">Rest Signer - Assinatura com
		Politica de Assinatura</a>
	<br />
	<br />
	<br />
	<span id="msg_install_ext_chrome" style="display:none">
	<span class="label label-danger">IMPORTANTE:</span>
	Parece que seu navegador ainda não tem a extensão Blue Crystal instalada. 
	<br/>
	<a 
		href="https://chrome.google.com/webstore/detail/blue-crystal-signer/inlgdajmhicinhamnepnpdneamfgjcgl?hl=pt-BR&authuser=2">
		Antes de iniciar o processo instale a entensao.</a> e o componente nativo 	<a 
		href="https://github.com/bluecrystalsign/signer-source-vstudio/tree/master/dist">E
		instale daqui</a>
	</span>
	<br />
	
	<span id="msg_install_native" style="display:none">
	<span class="label label-danger">IMPORTANTE:</span>
	Parece que seu computador ainda não tem o componente nativo Blue Crystal instalada. <a id="msg_install_ext_native"
		href="https://github.com/bluecrystalsign/signer-source-vstudio/tree/master/dist">Instale o 'native messaging' daqui</a>
	</span>
	<br />


	<h4>Passo 1: Arraste um documento para a area abaixo.</h4>
	<div id="dropbox">Arraste o arquivo que deseja assinar para
		aqui...</div>
	<div id="status"></div>

	<h5>

		Passo 2: na janela exibida selecione o certificado que deseja utilizar
		e aguarde.</br> Serïao exibidos os dados do certificado e em seguida a assinatura.
	</h5>
	<p>
	<h4>
		<span class="label label-success">Certificado</span>
	</h4>
	Abaixo pararecerao os dados do certificado usado na assinatura.
	<br />
	<span id="parsedCert">...</span>
	<p>
	<p>
	<h4>
		<span class="label label-success">Assinatura</span>
	</h4>
	abaixo aparecera assinatura digital em foramto base 64
	<br />
	<span id="bluc_signed_envelope"
		onchange="bluc_signed_envelope_onchange();">...</span>
	<p>
	<!-- Esse div contém uma série de variáveis utilizadas pela extensão e portanto não deve ser exibido -->
	<div style="display: none;">
		<b>response:</b>
		<div id='response'></div>
		
		<!-- Paginas que contenham a funcionalidade do Blue Crystal deve ter essa variavel com o valor 'true'. 
		Isso indica para a extensão que ela deve se colocar disponivel -->
		<b>load
			icon:</b> <span id="bluc_load_icon">true</span><br /> 

		
		<!-- Mensagens e codigos de erro são exibidos quando atualizadas as 2 variaveis abaixo -->
		<b>error code:</b> <span id="bluc_error_code"
			onchange="bluc_error_code_onchange();"></span><br /> 
		<b>error
			message:</b> <span id="bluc_error_message"></span><br />
			
		<!--  Quando a extensão é carregada essa variavel é alterada para gerar um evento e não solicitar que o usuário instale a extensão --> 
		<b>load
			extension:</b> <span id="bluc_load_extension" onchange="bluc_load_extension_onchange();">false</span><br /> 

		<!--  Quando o componente nativo está disponivel essa variavel é alterada para gerar um evento e não solicitar que o usuário instale a extensão --> 
		<b>is native:</b> <span id="bluc_load_native" onchange="bluc_load_native_onchange();">false</span><br />
		
		 
		 <!-- indica qual o passo do processo em que a assinatura está -->
		<b>status:</b> <span
			id="bluc_status" onchange="bluc_status_onchange();"></span><br /> 
		<b>message:</b> <span id="message"></span><br />
		
		<!-- o conteudo do certificado em base64 -->
		<b>certb64:</b> <span id="bluc_certb64"
			onchange="bluc_certb64_onchange();"></span><br /> 
			
		<!-- thumprint do certificado digitai -->
		<b>thumbprint:</b>
			<span id="bluc_thumbprint"></span><br /> 
			
		<!-- subject / assuntoo / titular do certificado digitai -->
		<b>subject:</b> <span
			id="bluc_subject"></span><br /> 
			
		<!-- tamanho (em bits) do certificado digitai -->
		<b>keySize:</b> <span
			id="bluc_key_size"></span><br /> <b>hash:</b> <span id="bluc_hash"></span><br />

		<!-- algoritmo usado na assinatura -->
		<b>hash alg:</b> <span id="bluc_hash_alg"></span><br /> 
		
		<!-- horario da geração assinatura -->
		<b>time:</b> <span id="bluc_time"></span><br /> 
		
		<!-- atributos assinados, e ao final a assinatura gerada -->
		<b>sa:</b> <span id="bluc_signed_attr"
			onchange="bluc_signed_attr_onchange();"></span><br /> 
		
		<!-- url utilizada para a operação inicial de geração dos atributos assinavies -->	
		<b>loadSignatureUrl:</b>
		<span id="bluc_load_signature_url">http://localhost:8080/example/LoadSignature</span><br />
		
		<!-- url utilizada para a criação do envelope -->
		<b>CreateEnvelopeUrl:</b> <span id="bluc_create_envelope_url">http://localhost:8080/example/CreateEnvelope</span><br />
	</div>
</body>
</html>
